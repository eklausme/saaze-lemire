---
date: "2011-11-28 12:00:00"
title: "3 surprising facts about the computation of scalar products"
index: false
---

[18 thoughts on &ldquo;3 surprising facts about the computation of scalar products&rdquo;](/lemire/blog/2011/11-28-3-surprising-facts-about-the-computation-of-the-scalar-product)

<ol class="comment-list">
<li id="comment-54801" class="comment byuser comment-author-lemire bypostauthor even thread-even depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/2ca999bef9535950f5b84281a4dab006?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/2ca999bef9535950f5b84281a4dab006?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" decoding="async" /> <b class="fn"><a href="https://lemire.me/blog/" class="url" rel="ugc">Daniel Lemire</a></b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2011-11-28T12:53:12+00:00">November 28, 2011 at 12:53 pm</time></a> </div>
<div class="comment-content">
<p>@John</p>
<p>Thanks!</p>
</div>
</li>
<li id="comment-54802" class="comment odd alt thread-odd thread-alt depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/8528397254e98a159c68bb0ce20eae71?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/8528397254e98a159c68bb0ce20eae71?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" decoding="async" /> <b class="fn"><a href="https://mobile.twitter.com/i/guest#!/mymedialite" class="url" rel="ugc external nofollow">Zeno</a></b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2011-11-28T12:54:57+00:00">November 28, 2011 at 12:54 pm</time></a> </div>
<div class="comment-content">
<p>Interesting. Thank you for sharing your results!</p>
</div>
</li>
<li id="comment-54805" class="comment byuser comment-author-lemire bypostauthor even thread-even depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/2ca999bef9535950f5b84281a4dab006?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/2ca999bef9535950f5b84281a4dab006?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn"><a href="https://lemire.me/blog/" class="url" rel="ugc">Daniel Lemire</a></b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2011-11-28T14:12:17+00:00">November 28, 2011 at 2:12 pm</time></a> </div>
<div class="comment-content">
<p>@Aleksey</p>
<p>Thanks. I confirm your good results, I will update the blog post.</p>
</div>
</li>
<li id="comment-54808" class="comment byuser comment-author-lemire bypostauthor odd alt thread-odd thread-alt depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/2ca999bef9535950f5b84281a4dab006?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/2ca999bef9535950f5b84281a4dab006?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn"><a href="https://lemire.me/blog/" class="url" rel="ugc">Daniel Lemire</a></b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2011-11-28T15:03:52+00:00">November 28, 2011 at 3:03 pm</time></a> </div>
<div class="comment-content">
<p>@John</p>
<p>I&rsquo;m trying to update my results the best I can.</p>
<p>Who knew that a technical blog post could be so time consuming?</p>
</div>
</li>
<li id="comment-54811" class="comment byuser comment-author-lemire bypostauthor even thread-even depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/2ca999bef9535950f5b84281a4dab006?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/2ca999bef9535950f5b84281a4dab006?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn"><a href="https://lemire.me/blog/" class="url" rel="ugc">Daniel Lemire</a></b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2011-11-28T15:39:00+00:00">November 28, 2011 at 3:39 pm</time></a> </div>
<div class="comment-content">
<p>@Aleksey</p>
<p>I know, I don&rsquo;t usually update posts so fast. Sorry.</p>
</div>
</li>
<li id="comment-54813" class="comment byuser comment-author-lemire bypostauthor odd alt thread-odd thread-alt depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/2ca999bef9535950f5b84281a4dab006?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/2ca999bef9535950f5b84281a4dab006?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn"><a href="https://lemire.me/blog/" class="url" rel="ugc">Daniel Lemire</a></b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2011-11-28T16:06:43+00:00">November 28, 2011 at 4:06 pm</time></a> </div>
<div class="comment-content">
<p>@John</p>
<p>Good question. I wonder why it would make a difference for integer arithmetic. Something to do with overflows maybe?</p>
</div>
</li>
<li id="comment-54816" class="comment byuser comment-author-lemire bypostauthor even thread-even depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/2ca999bef9535950f5b84281a4dab006?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/2ca999bef9535950f5b84281a4dab006?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn"><a href="https://lemire.me/blog/" class="url" rel="ugc">Daniel Lemire</a></b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2011-11-28T17:12:44+00:00">November 28, 2011 at 5:12 pm</time></a> </div>
<div class="comment-content">
<p>@Anonymous</p>
<p>(1) Scalar products are not limited to linear algebra. Almost all software uses something like a scalar product. Something like this:</p>
<p>sales = price * quantity</p>
<p>is a scalar product. Also, it is often a bottleneck.</p>
<p>Image processing is filled with scalar products. Computer graphics use scalar products all the time.</p>
<p>(2) BLAS implementations almost certainly use something that looks like a scalar product underneath. You may not want to tinker with it, but it will still be impacted by the features of your processors and of the compiler.</p>
</div>
</li>
<li id="comment-54817" class="comment odd alt thread-odd thread-alt depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/1ea96001c7bdd84cc07b71d9d3ed65cf?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/1ea96001c7bdd84cc07b71d9d3ed65cf?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn">Stanley Lee</b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2011-11-28T17:35:07+00:00">November 28, 2011 at 5:35 pm</time></a> </div>
<div class="comment-content">
<p>Wow, there are a lot of intricate details to know here that could be useful. Thanks for sharing!</p>
</div>
</li>
<li id="comment-54800" class="comment even thread-even depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/3ccaf45d7ab8ecc0e412fe911c9b9d10?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/3ccaf45d7ab8ecc0e412fe911c9b9d10?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn">John Regehr</b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2011-11-28T12:44:17+00:00">November 28, 2011 at 12:44 pm</time></a> </div>
<div class="comment-content">
<p>Nice to see measurement-based blogging :).</p>
<p>When compiling any code of this sort, you should try the Intel compiler as well.</p>
<p>10,000 reps may be enough for your simple rdtsc to give reliable results, but I wouldn&rsquo;t count on it. It&rsquo;s easy to do better:</p>
<p><a href="http://blog.regehr.org/archives/330" rel="nofollow ugc">http://blog.regehr.org/archives/330</a></p>
</div>
</li>
<li id="comment-54803" class="comment odd alt thread-odd thread-alt depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/79470b8a08a97c7f3be713f70c71f3aa?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/79470b8a08a97c7f3be713f70c71f3aa?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn">Aleksey Bader</b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2011-11-28T14:03:11+00:00">November 28, 2011 at 2:03 pm</time></a> </div>
<div class="comment-content">
<p>It&rsquo;s probably worth to enable -mavx optimization option on recent core i7.<br/>
I&rsquo;ve got speed up for 32-bit integers: from 0.991442 to 0.438392.</p>
</div>
</li>
<li id="comment-54804" class="comment even thread-even depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/79470b8a08a97c7f3be713f70c71f3aa?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/79470b8a08a97c7f3be713f70c71f3aa?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn">Aleksey Bader</b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2011-11-28T14:11:14+00:00">November 28, 2011 at 2:11 pm</time></a> </div>
<div class="comment-content">
<p>BTW, for 64-bit integer with SSE2 enabled I have best result &#8211; 1.073550 (manually unrolled loop).<br/>
The rest is pretty similar.</p>
<p>gcc version 4.6.1 (Ubuntu/Linaro 4.6.1-9ubuntu3)<br/>
Intel(R) Core(TM) i7-2600K CPU @ 3.40GHz</p>
</div>
</li>
<li id="comment-54806" class="comment odd alt thread-odd thread-alt depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/3ccaf45d7ab8ecc0e412fe911c9b9d10?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/3ccaf45d7ab8ecc0e412fe911c9b9d10?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn">John Regehr</b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2011-11-28T14:28:09+00:00">November 28, 2011 at 2:28 pm</time></a> </div>
<div class="comment-content">
<p>Here&rsquo;s what I get on an i7-920, which does not have AVX. &ldquo;current-gcc&rdquo; is from a few days ago, &ldquo;icc&rdquo; is Intel 12.1.0.</p>
<p>$ current-gcc -funroll-loops -Ofast scalar.c ; ./a.out<br/>
uint32 = 1.041528<br/>
uint64 = 4.266846<br/>
uint32 2&#215;2 = 1.347658<br/>
uint64 2&#215;2 = 4.050428<br/>
float = 0.786304<br/>
float 2&#215;2 = 0.785491<br/>
double = 10.993460<br/>
double 2&#215;2 = 5.679850</p>
<p>$ current-gcc -funroll-loops -Ofast -mno-sse2 scalar.c ; ./a.out<br/>
uint32 = 2.007275<br/>
uint64 = 2.011980<br/>
uint32 2&#215;2 = 2.006285<br/>
uint64 2&#215;2 = 2.013779<br/>
float = 0.942085<br/>
float 2&#215;2 = 2.471436<br/>
double = 279.546434<br/>
double 2&#215;2 = 142.930305</p>
<p>$ icc -fast scalar.c ; ./a.out<br/>
uint32 = 0.766303<br/>
uint64 = 3.629643<br/>
uint32 2&#215;2 = 1.520190<br/>
uint64 2&#215;2 = 3.605145<br/>
float = 0.512532<br/>
float 2&#215;2 = 0.827342<br/>
double = 2.104804<br/>
double 2&#215;2 = 2.390149</p>
</div>
</li>
<li id="comment-54807" class="comment even thread-even depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/79470b8a08a97c7f3be713f70c71f3aa?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/79470b8a08a97c7f3be713f70c71f3aa?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn">Aleksey Bader</b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2011-11-28T14:37:12+00:00">November 28, 2011 at 2:37 pm</time></a> </div>
<div class="comment-content">
<p>Even though my CPU has AVX, gcc utilizes only 4-element registers (xmm) even with -mavx option enabled.<br/>
Pretty strange&#8230;<br/>
I would expect to see ymm registers utilization.</p>
</div>
</li>
<li id="comment-54809" class="comment odd alt thread-odd thread-alt depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/79470b8a08a97c7f3be713f70c71f3aa?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/79470b8a08a97c7f3be713f70c71f3aa?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn">Aleksey Bader</b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2011-11-28T15:18:09+00:00">November 28, 2011 at 3:18 pm</time></a> </div>
<div class="comment-content">
<p>I played a bit with the code and it seems gcc is not good enough to optimize scalar product with SIMD.<br/>
&ldquo;In theory, the SSE instructions are ideally suited to the computation of scalar products.&rdquo;<br/>
It&rsquo;s true only for SOA data layout and there is no data dependency between loop iterations.<br/>
I separated multiplication of two arrays and accumulation: 3.583192 (compare with 10). More then 2x speed up because of full utilization of AVX registers.<br/>
I&rsquo;m surprised that gcc failed to optimize so common problem.</p>
</div>
</li>
<li id="comment-54810" class="comment even thread-even depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/79470b8a08a97c7f3be713f70c71f3aa?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/79470b8a08a97c7f3be713f70c71f3aa?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn">Aleksey Bader</b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2011-11-28T15:28:48+00:00">November 28, 2011 at 3:28 pm</time></a> </div>
<div class="comment-content">
<p>Oh&#8230;<br/>
Did see the latests update &#8211; you updating your post too quick for me.<br/>
I seem to need GCC upgrade because -Ofast option doesn&rsquo;t help for 4.6.1.<br/>
Thanks.</p>
</div>
</li>
<li id="comment-54812" class="comment odd alt thread-odd thread-alt depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/3ccaf45d7ab8ecc0e412fe911c9b9d10?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/3ccaf45d7ab8ecc0e412fe911c9b9d10?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn">John Regehr</b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2011-11-28T15:42:37+00:00">November 28, 2011 at 3:42 pm</time></a> </div>
<div class="comment-content">
<p>Another thing to ask is, does -ffast-math affect results in a way that matters for this application? I believe -Ofast enables that flag, and perhaps others that may have observable behavior. I&rsquo;m not sure if icc&rsquo;s -fast flag has similar consequences.</p>
</div>
</li>
<li id="comment-54814" class="comment even thread-even depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo avatar-default" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn">Anonymous</b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2011-11-28T16:34:32+00:00">November 28, 2011 at 4:34 pm</time></a> </div>
<div class="comment-content">
<p>&ldquo;The speed of many algorithms depends on how quickly you can multiply matrices or compute distances. In turn, these computations depend on the scalar product. &rdquo;</p>
<p>In high performance computing, normally you do not compute matrix products directly through scalar products, but rely on blocking as much as you can. The reason is that loading data to the cache is expensive, so you&rsquo;d rather perform as much computation as you can while they&rsquo;re in, and for this blocking is more effective than successive scalar products.</p>
<p>As for which is the best algorithm, the general answer for floating point numbers is &ldquo;don&rsquo;t do it yourself, rely a highly optimized BLAS implementation&rdquo;. ðŸ™‚</p>
</div>
</li>
<li id="comment-54815" class="comment odd alt thread-odd thread-alt depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/3ccaf45d7ab8ecc0e412fe911c9b9d10?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/3ccaf45d7ab8ecc0e412fe911c9b9d10?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn">John Regehr</b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2011-11-28T17:03:12+00:00">November 28, 2011 at 5:03 pm</time></a> </div>
<div class="comment-content">
<p>Daniel, I don&rsquo;t know the implications of -ffast-math. I&rsquo;m basically an integer person&#8230;</p>
<p>Re. BLAS, sure &#8212; but it&rsquo;s still fun (for some of us at least) to understand the interactions between, and limitations of, our compilers and SIMD units.</p>
</div>
</li>
</ol>
