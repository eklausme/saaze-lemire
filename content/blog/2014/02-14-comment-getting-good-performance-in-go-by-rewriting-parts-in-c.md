---
date: "2014-02-14 12:00:00"
title: "Getting good performance in Go by rewriting parts in C?"
index: false
---

[20 thoughts on &ldquo;Getting good performance in Go by rewriting parts in C?&rdquo;](/lemire/blog/2014/02-14-getting-good-performance-in-go-by-rewriting-parts-in-c)

<ol class="comment-list">
<li id="comment-111542" class="comment even thread-even depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/6c76488dff9b5d9a872dff88f008f88e?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/6c76488dff9b5d9a872dff88f008f88e?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" decoding="async" /> <b class="fn"><a href="https://mobile.twitter.com/benbjohnson" class="url" rel="ugc external nofollow">Ben Johnson</a></b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2014-02-14T10:58:09+00:00">February 14, 2014 at 10:58 am</time></a> </div>
<div class="comment-content">
<p>There&rsquo;s a decent amount of overhead to using CGO. It&rsquo;s definitely not meant for small, quick functions. You can actually see all the intermediate C wrapper code that&rsquo;s generated by passing the -work flag to &ldquo;go build&rdquo;.</p>
<p>I created a gist for a simple CGO invocation and copied all the files from the work directory:</p>
<p><a href="https://gist.github.com/benbjohnson/f33106b86036bcc72ba7" rel="nofollow ugc">https://gist.github.com/benbjohnson/f33106b86036bcc72ba7</a></p>
<p>I have had a lot of success with calling into CGO functions that perform all their work without context switching. Go structs also seem to work well when passed to C (as long as they&rsquo;re not GC&rsquo;d) and I&rsquo;ve used some crazy mixes of Go+C+LLVM and it all works fine.</p>
</div>
</li>
<li id="comment-111546" class="comment odd alt thread-odd thread-alt depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/d13390be21fa7745883cdae014a3d5b0?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/d13390be21fa7745883cdae014a3d5b0?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" decoding="async" /> <b class="fn">Tony Wilson</b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2014-02-14T12:14:10+00:00">February 14, 2014 at 12:14 pm</time></a> </div>
<div class="comment-content">
<p>An alternative for small functions is to use the Go C compiler or even the assembler. Once you get past the slightly quirky coding, it&rsquo;s quite &lsquo;nice&rsquo;. Dave Cheney did a simple intro blog on the subject if I remember correctly. Also the pkg source has a few implementations. Look for .goc files and their .go callers.</p>
</div>
</li>
<li id="comment-111550" class="comment byuser comment-author-lemire bypostauthor even thread-even depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/2ca999bef9535950f5b84281a4dab006?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/2ca999bef9535950f5b84281a4dab006?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn"><a href="https://lemire.me/en/" class="url" rel="ugc">Daniel Lemire</a></b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2014-02-14T12:39:55+00:00">February 14, 2014 at 12:39 pm</time></a> </div>
<div class="comment-content">
<p>@Tony</p>
<p>I&rsquo;d be very interested if anyone could improve Will&rsquo;s bitset class. Can you do better than I did?</p>
</div>
</li>
<li id="comment-111553" class="comment odd alt thread-odd thread-alt depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/d13390be21fa7745883cdae014a3d5b0?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/d13390be21fa7745883cdae014a3d5b0?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn">Tony Wilson</b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2014-02-14T14:10:42+00:00">February 14, 2014 at 2:10 pm</time></a> </div>
<div class="comment-content">
<p>I&rsquo;ll give it a Go &#8211; just don&rsquo;t hold your breath; I&rsquo;m busy for the next few days.</p>
</div>
</li>
<li id="comment-111558" class="comment even thread-even depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/e841415081a623b7f4d2cf02ae2320a2?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/e841415081a623b7f4d2cf02ae2320a2?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn">Aaron Blohowiak</b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2014-02-14T17:12:25+00:00">February 14, 2014 at 5:12 pm</time></a> </div>
<div class="comment-content">
<p>Going from 12usec to 9usec would be a 33% improvement. However, I found the time of my whole program to be dominated by GC.</p>
<p>While Will&rsquo;s library offers InPlace functions, to use them with a reused buffer requires copying which lead to a slower overall program.</p>
<p>Finally, by not supporting dynamic bitset growth, I was able to avoid all the work that Willf&rsquo;s library performs when doing Set() and Test(). This trades code flexibility for performance, but has not been a problem in my use-cases.</p>
</div>
</li>
<li id="comment-111562" class="comment odd alt thread-odd thread-alt depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/bcd7bb550c7f12bfc5108a0573c3fa49?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/bcd7bb550c7f12bfc5108a0573c3fa49?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn">Munch</b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2014-02-14T18:30:34+00:00">February 14, 2014 at 6:30 pm</time></a> </div>
<div class="comment-content">
<p>The only reason a C++ compiler would outperform Go in this micro-benchmark, and it is a micro-benchmark, is that the built-in compiles to a single CPU instruction on contemporary CPUs. Go doesn&rsquo;t have built-ins like that. Also, because your C++ code relies on built-ins, it&rsquo;s actually inlining and unrolling the loop, which Go&rsquo;s optimizer isn&rsquo;t doing on its own yet.</p>
<p>I haven&rsquo;t tested it, but I&rsquo;m willing to bet that you&rsquo;ll get faster if you inline the popcount_2 function, and you&rsquo;ll get faster still if you unroll the loop manually. The former removes the relatively expensive subroutine call overhead, and the latter amortizes the looping overhead.</p>
</div>
</li>
<li id="comment-111564" class="comment even thread-even depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/bcd7bb550c7f12bfc5108a0573c3fa49?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/bcd7bb550c7f12bfc5108a0573c3fa49?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn">Munch</b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2014-02-14T19:04:19+00:00">February 14, 2014 at 7:04 pm</time></a> </div>
<div class="comment-content">
<p>Actually, I just tested myself &#8212; and surprisingly, it makes only a small difference. I was able to reduce my time/op to 11.8us, which is an improvement, but not terribly significant. It&rsquo;s also very finicky, and noise from multitasking swamps the improvement.</p>
<p>Scratch that idea. 🙂</p>
</div>
</li>
<li id="comment-111565" class="comment odd alt thread-odd thread-alt depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/bcd7bb550c7f12bfc5108a0573c3fa49?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/bcd7bb550c7f12bfc5108a0573c3fa49?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn">Munch</b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2014-02-14T19:05:02+00:00">February 14, 2014 at 7:05 pm</time></a> </div>
<div class="comment-content">
<p>Sorry; baseline on my machine was 13.3us/op. Missed that important info. 🙂</p>
</div>
</li>
<li id="comment-111572" class="comment byuser comment-author-lemire bypostauthor even thread-even depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/2ca999bef9535950f5b84281a4dab006?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/2ca999bef9535950f5b84281a4dab006?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn"><a href="https://lemire.me/en/" class="url" rel="ugc">Daniel Lemire</a></b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2014-02-14T22:23:54+00:00">February 14, 2014 at 10:23 pm</time></a> </div>
<div class="comment-content">
<p>@aaron</p>
<p><em>Finally, by not supporting dynamic bitset growth, I was able to avoid all the work that Willf&rsquo;s library performs when doing Set() and Test(). This trades code flexibility for performance, but has not been a problem in my use-cases.</em></p>
<p>I am not sure you are gaining anything at all by trading away this flexibility. I would like to see a benchmark.</p>
<p>The thing is&#8230; the software has to check whether the index is in range. What your code probably does is just fail when it is out of range. Will expands the underlying array.</p>
<p>It is possible that your version if faster, but there is no reason, in principle, that it should be measurably faster.</p>
</div>
</li>
<li id="comment-111574" class="comment byuser comment-author-lemire bypostauthor odd alt thread-odd thread-alt depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/2ca999bef9535950f5b84281a4dab006?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/2ca999bef9535950f5b84281a4dab006?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn"><a href="https://lemire.me/en/" class="url" rel="ugc">Daniel Lemire</a></b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2014-02-14T22:26:30+00:00">February 14, 2014 at 10:26 pm</time></a> </div>
<div class="comment-content">
<p>@Munch</p>
<p><em> Go doesn&rsquo;t have built-ins like that. </em></p>
<p>And it is a shame. It would take a few hours for the language authors to implement it and it could instantly speed up many algorithms.</p>
</div>
</li>
<li id="comment-111805" class="comment even thread-even depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/d13390be21fa7745883cdae014a3d5b0?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/d13390be21fa7745883cdae014a3d5b0?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn">Tony Wilson</b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2014-02-18T20:03:49+00:00">February 18, 2014 at 8:03 pm</time></a> </div>
<div class="comment-content">
<p>At last&#8230; My tuppence worth can be found at github.com/tHinqa/bitset</p>
</div>
</li>
<li id="comment-111831" class="comment odd alt thread-odd thread-alt depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/d13390be21fa7745883cdae014a3d5b0?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/d13390be21fa7745883cdae014a3d5b0?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn">Tony Wilson</b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2014-02-19T07:08:55+00:00">February 19, 2014 at 7:08 am</time></a> </div>
<div class="comment-content">
<p>Added the forgotten clz fallback code and tests. Not sure he clz 0 also undefined for the LZCNT cpu instruction but it shouldn&rsquo;t be.</p>
</div>
</li>
<li id="comment-111832" class="comment even thread-even depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/d13390be21fa7745883cdae014a3d5b0?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/d13390be21fa7745883cdae014a3d5b0?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn">Tony Wilson</b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2014-02-19T07:11:18+00:00">February 19, 2014 at 7:11 am</time></a> </div>
<div class="comment-content">
<p>he=is Damn autocorrect</p>
</div>
</li>
<li id="comment-111834" class="comment odd alt thread-odd thread-alt depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/d13390be21fa7745883cdae014a3d5b0?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/d13390be21fa7745883cdae014a3d5b0?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn">Tony Wilson</b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2014-02-19T07:13:12+00:00">February 19, 2014 at 7:13 am</time></a> </div>
<div class="comment-content">
<p>if Damn human error</p>
</div>
</li>
<li id="comment-111869" class="comment even thread-even depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/d13390be21fa7745883cdae014a3d5b0?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/d13390be21fa7745883cdae014a3d5b0?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn">Tony Wilson</b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2014-02-19T17:27:56+00:00">February 19, 2014 at 5:27 pm</time></a> </div>
<div class="comment-content">
<p>Just found that CPUID code is missing a MOVL $1!,AX at the beginning. Will fix and comment again &#8211; sorry about that</p>
</div>
</li>
<li id="comment-111878" class="comment odd alt thread-odd thread-alt depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/d13390be21fa7745883cdae014a3d5b0?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/d13390be21fa7745883cdae014a3d5b0?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn">Tony Wilson</b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2014-02-19T21:41:08+00:00">February 19, 2014 at 9:41 pm</time></a> </div>
<div class="comment-content">
<p>Fixed</p>
</div>
</li>
<li id="comment-111916" class="comment even thread-even depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/d13390be21fa7745883cdae014a3d5b0?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/d13390be21fa7745883cdae014a3d5b0?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn">Tony Wilson</b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2014-02-20T09:22:19+00:00">February 20, 2014 at 9:22 am</time></a> </div>
<div class="comment-content">
<p>POPCNT instruction tested using software.intel.com/en-us/articles/intel-software-development-emulator that I came across catching up on my freshmeat/freecode feed. Nice tool. Allows you to emulate any Intel CPU. Slow though. 365 micros for POPCNT 57 for hamming. Avoid 6.2 if windows; it&rsquo;s broken. Get the 2013-11 ver. </p>
<p>Ok. I think that&rsquo;s my QED to leave the rest to people with real machines. It&rsquo;s been interesting and I&rsquo;m considering a package of intrinsics for Go now.</p>
</div>
</li>
<li id="comment-112109" class="comment odd alt thread-odd thread-alt depth-1">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/c20a2c08c0072173d19fb94283c77737?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/c20a2c08c0072173d19fb94283c77737?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn"><a href="http://blog.vivekhaldar.com" class="url" rel="ugc external nofollow">Vivek Haldar</a></b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2014-02-22T16:28:40+00:00">February 22, 2014 at 4:28 pm</time></a> </div>
<div class="comment-content">
<p>C++ is a strong incumbent, but I think Go will gradually get there in terms of raw performance. </p>
<p>What is more interesting and surprising is that Go has ended up eating share from Java and even Python.</p>
</div>
</li>
<li id="comment-264386" class="comment even thread-even depth-1 parent">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/b091399da83212608f7ce92128d73030?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/b091399da83212608f7ce92128d73030?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn">Torsten Bronger</b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2017-01-01T21:40:45+00:00">January 1, 2017 at 9:40 pm</time></a> </div>
<div class="comment-content">
<p>â€œIn practice, Go has performance [â€¦] far inferior to C++ and Java.â€ â€“ this is way too general in my opinion. In fact, language shootouts normally have two distinct cluster points for performance, and Go is in the â€œstaticly-typedâ€ bunch.</p>
<p>There are indeed many cases when Go *is* slow. But people may refer to your article and this sentence, and it is misguiding, even with its context.</p>
</div>
<ol class="children">
<li id="comment-264434" class="comment byuser comment-author-lemire bypostauthor odd alt depth-2">
<div class="comment-author vcard">
<img alt src="https://secure.gravatar.com/avatar/2ca999bef9535950f5b84281a4dab006?s=56&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/2ca999bef9535950f5b84281a4dab006?s=112&#038;d=mm&#038;r=g 2x" class="avatar avatar-56 photo" height="56" width="56" loading="lazy" decoding="async" /> <b class="fn"><a href="https://lemire.me/en/" class="url" rel="ugc">Daniel Lemire</a></b> <span class="says">says:</span> </div>
<div class="comment-metadata"><time datetime="2017-01-02T15:22:11+00:00">January 2, 2017 at 3:22 pm</time></a> </div>
<div class="comment-content">
<p>@Torsten</p>
<p>This sentence was written in 2014. We are in 2017. Go has made progress compared to Java and C++. It is no longer the correct expectation that Go will run much slower than Java. At this time, Go still has serious limitations compared to Java, but a lot of work was done.</p>
<p>I revised the sentence to weaken it.</p>
</div>
</li>
</ol>
</li>
</ol>
